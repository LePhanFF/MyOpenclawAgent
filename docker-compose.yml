services:
  openclaw:
    build:
      context: .
      dockerfile: Dockerfile
      target: base
    environment:
      # Load environment from .env file
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-http://host.docker.internal:8001/v1}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-sk-dummy}
      - MODEL_NAME=${MODEL_NAME:-/model}
      
      # DinD Configuration (simplified)
      - DOCKER_HOST=unix:///var/run/docker.sock
      
      # Application Configuration
      - PYTHONPATH=/app
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DEBUG=${DEBUG:-false}
      - CONFIG_PATH=/app/config
    volumes:
      - ./config:/app/config:ro
      - openclaw-workspace:/app/github-workspace
      - openclaw-build-cache:/app/build-cache
      - openclaw-logs:/app/logs
      - openclaw_data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "8080:8080"  # Health check API
    networks:
      - openclaw-network
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s


volumes:
  openclaw_data:
    driver: local
  openclaw_workspace:
    driver: local
  openclaw_build_cache:
    driver: local
  openclaw_logs:
    driver: local
  openclaw-workspace:
    driver: local
  openclaw-build-cache:
    driver: local
  openclaw-logs:
    driver: local

networks:
  openclaw-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/16
          gateway: 172.22.0.1
    driver_opts:
      com.docker.network.bridge.name: openclaw-br0